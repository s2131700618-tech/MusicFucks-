-- æ”¾ç½®ä½ç½®ï¼šStarterGui -> LocalScript (é€™æ˜¯æ‚¨æœ€çµ‚å–®ä¸€çš„ LocalScript)
-- æ­¤è…³æœ¬ä¿®å¾©äº† Looped å±¬æ€§éŒ¯èª¤ï¼Œä¸¦åŒ…å«äº†æ‹–å‹•ã€é–‹/é—œå¾ªç’°å’Œæœ¬åœ°éŸ³æ¨‚æ§åˆ¶ã€‚

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Player = game.Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui")
local Workspace = game:GetService("Workspace")

-- å‰µå»ºå’Œæ§åˆ¶ LocalScript å¯æ§åˆ¶çš„ Sound å…ƒä»¶
local gameMusic = Instance.new("Sound")
gameMusic.Name = "GameMusicLocal"
gameMusic.Volume = 0.5
gameMusic.PlaybackSpeed = 1.0
gameMusic.Looped = true -- *** ä¿®æ­£ç‚ºæ­£ç¢ºçš„å±¬æ€§åç¨±ï¼šLooped = true ***
gameMusic.Parent = Workspace 

-- UI å…ƒä»¶åƒè€ƒè®Šé‡
local sG 
local controlPanel 
local openButton

-- ------------------------------
-- UI å‰µå»ºèˆ‡è¨­ç½®å‡½æ•¸
-- ------------------------------
local function createUI()
    -- å‰µå»º ScreenGui å®¹å™¨
    sG = Instance.new("ScreenGui")
    sG.Name = "MusicPlayerGui"
    sG.IgnoreGuiInset = true
    sG.Enabled = true
    sG.Parent = PlayerGui

    -- å‰µå»º ControlPanel (ä¸»æ¡†æ¶)
    controlPanel = Instance.new("Frame")
    controlPanel.Name = "ControlPanel"
    controlPanel.Size = UDim2.new(0.4, 0, 0.6, 0)
    controlPanel.AnchorPoint = Vector2.new(0.5, 0.5)
    controlPanel.Position = UDim2.new(0.5, 0, 0.5, 0)
    controlPanel.BackgroundColor3 = Color3.new(0, 0, 0)
    controlPanel.BorderSizePixel = 0
    controlPanel.Visible = false -- åˆå§‹è¨­ç½®ç‚ºã€Œé—œé–‰ã€ç‹€æ…‹
    controlPanel.Parent = sG

    -- å‰µå»º CloseButton (é—œé–‰ä¸»æ¡†æ¶)
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Text = "é—œé–‰"
    closeButton.TextScaled = true
    closeButton.Size = UDim2.new(0.2, 0, 0.05, 0)
    closeButton.Position = UDim2.new(0.05, 0, 0.6, 0)
    closeButton.BackgroundColor3 = Color3.new(0.8, 0.2, 0.2) 
    closeButton.TextColor3 = Color3.new(1, 1, 1)
    closeButton.BorderSizePixel = 0
    closeButton.Parent = sG 
    
    -- -------------------------
    -- å‰µå»º OpenButton (ç”¨æ–¼é‡è¤‡é–‹å•Ÿæ¡†æ¶)
    -- -------------------------
    openButton = Instance.new("TextButton")
    openButton.Name = "OpenButton"
    openButton.Text = "ğŸµ éŸ³æ¨‚æ§åˆ¶"
    openButton.TextScaled = true
    openButton.Size = UDim2.new(0.15, 0, 0.05, 0)
    openButton.Position = UDim2.new(0.05, 0, 0.9, 0) 
    openButton.BackgroundColor3 = Color3.new(0.2, 0.5, 0.8) 
    openButton.TextColor3 = Color3.new(1, 1, 1)
    openButton.BorderSizePixel = 0
    openButton.Parent = sG 
    openButton.Visible = true -- åˆå§‹è¨­ç½®ç‚ºã€Œé–‹å•ŸæŒ‰éˆ•å¯è¦‹ã€ç‹€æ…‹

    -- å‰µå»º ToggleButton
    local toggleMusicButton = Instance.new("TextButton")
    toggleMusicButton.Name = "ToggleMusicButton"
    toggleMusicButton.Text = "æ’­æ”¾" -- ç”±æ–¼åˆå§‹ç‚ºé—œé–‰ç‹€æ…‹ï¼ŒæŒ‰éˆ•é¡¯ç¤ºç‚ºã€Œæ’­æ”¾ã€
    toggleMusicButton.TextScaled = true
    toggleMusicButton.Size = UDim2.new(0.5, 0, 0.07, 0)
    toggleMusicButton.Position = UDim2.new(0.25, 0, 0.18, 0)
    toggleMusicButton.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
    toggleMusicButton.TextColor3 = Color3.new(1, 1, 1)
    toggleMusicButton.BorderSizePixel = 0
    toggleMusicButton.Parent = controlPanel

    -- å‰µå»ºè¼¸å…¥æ¬„ä½å’Œæ¨™ç±¤
    local inputs = {
        {name = "MusicIdInput", label = "ID:", default = "1234567890"},
        {name = "VolumeInput", label = "éŸ³é‡:", default = "0.5"},
        {name = "SpeedInput", label = "æ’­æ”¾é€Ÿåº¦:", default = "1.0"},
    }
    local yPos = 0.4
    local references = {}
    for _, data in ipairs(inputs) do
        -- æ¨™ç±¤
        local label = Instance.new("TextLabel", controlPanel)
        label.Text = data.label
        label.TextScaled = true
        label.Size = UDim2.new(0.35, 0, 0.05, 0)
        label.Position = UDim2.new(0.05, 0, yPos, 0)
        label.TextColor3 = Color3.new(1, 1, 1)
        label.BackgroundColor3 = Color3.new(0, 0, 0)
        label.BorderSizePixel = 0

        -- è¼¸å…¥æ¡†
        local input = Instance.new("TextBox", controlPanel)
        input.Name = data.name
        input.Text = data.default
        input.TextColor3 = Color3.new(1, 1, 1)
        input.TextScaled = true
        input.BorderSizePixel = 0
        input.Size = UDim2.new(0.5, 0, 0.05, 0)
        input.Position = UDim2.new(0.4, 0, yPos, 0)
        input.BackgroundColor3 = Color3.new(0.3, 0.3, 0.3)
        
        references[data.name] = input
        yPos = yPos + 0.1
    end
    
    return closeButton, toggleMusicButton, references.MusicIdInput, references.VolumeInput, references.SpeedInput
end

-- åŸ·è¡Œå‰µå»ºä¸¦ç²å–å…ƒä»¶
local closeButton, toggleMusicButton, musicIdInput, volumeInput, speedInput = createUI()

-- ------------------------------
-- æ ¸å¿ƒé‚è¼¯ (åŒ…å«æ‹–å‹•ã€é–‹/é—œå¾ªç’°å’ŒéŸ³æ¨‚æ§åˆ¶)
-- ------------------------------
local isDragging = false
local dragStartPos = Vector2.new(0, 0)
local frameStartPos = UDim2.new(0, 0, 0, 0)

-- æ‹–å‹•é‚è¼¯
RunService.RenderStepped:Connect(function()
    if isDragging and controlPanel then
        local currentMousePos = UserInputService:GetMouseLocation()
        local deltaX = currentMousePos.X - dragStartPos.X
        local deltaY = currentMousePos.Y - dragStartPos.Y
        local screenWidth = sG.AbsoluteSize.X
        local screenHeight = sG.AbsoluteSize.Y
        local newScaleX = frameStartPos.Scale.X + (deltaX / screenWidth)
        local newScaleY = frameStartPos.Scale.Y + (deltaY / screenHeight)
        controlPanel.Position = UDim2.new(newScaleX, 0, newScaleY, 0)
    end
end)
controlPanel.InputBegan:Connect(function(input, gameProcessedEvent)
    if not gameProcessedEvent and input.UserInputType == Enum.UserInputType.MouseButton1 then 
        isDragging = true
        dragStartPos = UserInputService:GetMouseLocation() 
        frameStartPos = controlPanel.Position 
    end
end)
UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        isDragging = false
    end
end)

-- é–‹/é—œå¾ªç’°ç³»çµ±
closeButton.MouseButton1Click:Connect(function() 
    controlPanel.Visible = false 
    openButton.Visible = true 
end)

openButton.MouseButton1Click:Connect(function() 
    controlPanel.Visible = true 
    openButton.Visible = false
end)


-- éŸ³æ¨‚æ§åˆ¶é‚è¼¯ (ç›´æ¥æ“ä½œæœ¬åœ° Sound å…ƒä»¶)
toggleMusicButton.MouseButton1Click:Connect(function() 
    if gameMusic.IsPlaying then
        gameMusic:Pause()
        toggleMusicButton.Text = "æ’­æ”¾"
    else
        gameMusic:Play()
        toggleMusicButton.Text = "æš«åœ"
    end
end)

-- è¼¸å…¥è™•ç†é‚è¼¯ (ç›´æ¥æ“ä½œæœ¬åœ° Sound å…ƒä»¶)
local function handleInputChanged(inputObject)
    local inputValue = inputObject.Text
    
    if inputObject == volumeInput then
        local volumeValue = tonumber(inputValue)
        if volumeValue then gameMusic.Volume = math.clamp(volumeValue, 0, 10009999999997656883235) end
    elseif inputObject == speedInput then
        local speedValue = tonumber(inputValue)
        if speedValue then gameMusic.PlaybackSpeed = math.clamp(speedValue, 0.01, 100) end
    elseif inputObject == musicIdInput then
        local assetId = inputValue:match("^%d+$")
        if assetId then 
            gameMusic.SoundId = "rbxassetid://" .. assetId
            -- è¨­ç½®æ–°çš„ SoundId å¾Œè‡ªå‹•æ’­æ”¾ï¼Œå¦‚æœç•¶å‰æ˜¯æ’­æ”¾ç‹€æ…‹
            if not gameMusic.IsPlaying then
                gameMusic:Play()
                toggleMusicButton.Text = "æš«åœ"
            end
        end
    end
end

musicIdInput.FocusLost:Connect(function() handleInputChanged(musicIdInput) end)
volumeInput.FocusLost:Connect(function() handleInputChanged(volumeInput) end)
speedInput.FocusLost:Connect(function() handleInputChanged(speedInput) end)

print("âœ… å–®ä¸€ LocalScript å·²å•Ÿå‹•ï¼Œæ‰€æœ‰åŠŸèƒ½å’Œå±¬æ€§å·²ä¿®æ­£ã€‚")
